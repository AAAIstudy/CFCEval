import re
from io import BytesIO
import requests
import validators
from cookbook.helper.ingredient_parser import IngredientParser
from cookbook.helper.recipe_html_import import get_recipe_from_source
from cookbook.helper.recipe_url_import import iso_duration_to_minutes
from cookbook.models import Ingredient, Keyword, Recipe, Step



def get_recipe_from_file(self, file):
    recipe_html = file.getvalue().decode("utf-8")

    recipe_json, recipe_tree, html_data, images = get_recipe_from_source(recipe_html, 'CookBookApp', self.request)

    recipe = Recipe.objects.create(
        name=recipe_json['name'].strip(),
        created_by=self.request.user, internal=True,
        space=self.request.space)

    try:
        recipe.working_time = iso_duration_to_minutes(recipe_json['prepTime'])
        recipe.waiting_time = iso_duration_to_minutes(recipe_json['cookTime'])
    except Exception:
        pass
    step = Step.objects.create(instruction=recipe_json['recipeInstructions'], space=self.request.space, )
    try:
        recipe.servings = re.findall('([0-9])+', recipe_json['recipeYield'])[0]
    except Exception as e:
        pass


    if 'nutrition' in recipe_json:
        step.instruction = step.instruction + '\n\n' + recipe_json['nutrition']

    step.save()
    recipe.steps.add(step)

    ingredient_parser = IngredientParser(self.request, True)
    # for ingredient in recipe_json['recipeIngredient']:
    index=0
    while index < len(recipe_json['recipeIngredient']):
        ingredient = recipe_json['recipeIngredient'][index]
        f = ingredient_parser.get_food(ingredient['ingredient']['text'])
        u = ingredient_parser.get_unit(ingredient['unit']['text'])
        step.ingredients.add(Ingredient.objects.create(
            food=f, unit=u, amount=ingredient['amount'], note=ingredient['note'],  space=self.request.space,
        ))
        index += 1

    if len(images) > 0:
        try:
            # the following code is for fixing the vulnerability CWE-918 (Server-Side Request Forgery )
            # https://cwe.mitre.org/data/definitions/918.html
            # https://owasp.org/www-project-web-security-testing-guide/v41/4-Web_Application_Security_Testing/05-Authorization_Testing/02-Testing_for_Server_Side_Request_Forgery_(SSRF)_and_Related_Vulnerabilities.html
            # https://docs.djangoproject.com/en/3.1/ref/request-response/#django.http.HttpRequest.build_absolute_uri
            image = images[0]