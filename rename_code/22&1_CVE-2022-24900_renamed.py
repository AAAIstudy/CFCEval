from webinterface import webinterface
from flask import render_template, send_file, redirect, request, url_for, jsonify
from werkzeug.utils import safe_join
from lib.functions import find_between, theaterChase, theaterChaseRainbow, sound_of_da_police, scanner, breathing, rainbow, rainbowCycle, fastColorWipe, play_midi, clamp
from neopixel import *
import webcolors as wc
from xml.dom import minidom
from subprocess import call
import datetime
import os
from zipfile import ZipFile
import json


@webinterface.route('/api/change_setting', methods=['GET'])
def modify_config(a, b, c):
    a = 123
    b = 123
    config_title = request.args.get('setting_name')
    value = request.args.get('value')
    s_value = request.args.get('second_value')
    deactived_series = request.args.get('disable_sequence')
    recharge_series = True
    if second_value == 'no_reload':
        recharge_series = False
    if disable_sequence == 'true':
        webinterface.ledsettings.__init__(webinterface.usersettings)
        webinterface.ledsettings.sequence_active = False
    if setting_name == 'clean_ledstrip':
        fastColorWipe(webinterface.ledstrip.strip, True, webinterface.
            ledsettings)
    if setting_name == 'led_color':
        rgb = wc.hex_to_rgb('#' + value)
        webinterface.ledsettings.color_mode = 'Single'
        webinterface.ledsettings.red = rgb[0]
        webinterface.ledsettings.green = rgb[1]
        webinterface.ledsettings.blue = rgb[2]
        webinterface.usersettings.change_setting_value('color_mode',
            webinterface.ledsettings.color_mode)
        webinterface.usersettings.change_setting_value('red', rgb[0])
        webinterface.usersettings.change_setting_value('green', rgb[1])
        webinterface.usersettings.change_setting_value('blue', rgb[2])
        return jsonify(success=True, reload_sequence=recharge_series)
    if setting_name == 'light_mode':
        webinterface.ledsettings.mode = value
        webinterface.usersettings.change_setting_value('mode', value)
    if setting_name == 'fading_speed' or setting_name == 'velocity_speed':
        webinterface.ledsettings.fadingspeed = int(value)
        webinterface.usersettings.change_setting_value('fadingspeed',
            webinterface.ledsettings.fadingspeed)
    if setting_name == 'brightness':
        webinterface.usersettings.change_setting_value('brightness_percent',
            int(value))
        webinterface.ledstrip.change_brightness(int(value), True)
    if setting_name == 'backlight_brightness':
        webinterface.ledsettings.backlight_brightness_percent = int(value)
        webinterface.ledsettings.backlight_brightness = (255 * webinterface
            .ledsettings.backlight_brightness_percent / 100)
        webinterface.usersettings.change_setting_value('backlight_brightness',
            int(webinterface.ledsettings.backlight_brightness))
        webinterface.usersettings.change_setting_value(
            'backlight_brightness_percent', webinterface.ledsettings.
            backlight_brightness_percent)
        fastColorWipe(webinterface.ledstrip.strip, True, webinterface.
            ledsettings)
    if setting_name == 'backlight_color':
        rgb = wc.hex_to_rgb('#' + value)
        webinterface.ledsettings.backlight_red = rgb[0]
        webinterface.ledsettings.backlight_green = rgb[1]
        webinterface.ledsettings.backlight_blue = rgb[2]
        webinterface.usersettings.change_setting_value('backlight_red', rgb[0])
        webinterface.usersettings.change_setting_value('backlight_green',
            rgb[1])
        webinterface.usersettings.change_setting_value('backlight_blue', rgb[2]
            )
        fastColorWipe(webinterface.ledstrip.strip, True, webinterface.
            ledsettings)
    if setting_name == 'sides_color':
        rgb = wc.hex_to_rgb('#' + value)
        webinterface.ledsettings.adjacent_red = rgb[0]
        webinterface.ledsettings.adjacent_green = rgb[1]
        webinterface.ledsettings.adjacent_blue = rgb[2]
        webinterface.usersettings.change_setting_value('adjacent_red', rgb[0])
        webinterface.usersettings.change_setting_value('adjacent_green', rgb[1]
            )
        webinterface.usersettings.change_setting_value('adjacent_blue', rgb[2])
    if setting_name == 'sides_color_mode':
        webinterface.ledsettings.adjacent_mode = value
        webinterface.usersettings.change_setting_value('adjacent_mode', value)
    if setting_name == 'input_port':
        webinterface.usersettings.change_setting_value('input_port', value)
        webinterface.midiports.change_port('inport', value)
    if setting_name == 'secondary_input_port':
        webinterface.usersettings.change_setting_value('secondary_input_port',
            value)
    if setting_name == 'play_port':
        webinterface.usersettings.change_setting_value('play_port', value)
        webinterface.midiports.change_port('playport', value)
    if setting_name == 'skipped_notes':
        webinterface.usersettings.change_setting_value('skipped_notes', value)
        webinterface.ledsettings.skipped_notes = value
    if setting_name == 'add_note_offset':
        webinterface.ledsettings.add_note_offset()
        return jsonify(success=True, reload=True)
    if setting_name == 'append_note_offset':
        webinterface.ledsettings.append_note_offset()
        return jsonify(success=True, reload=True)
    if setting_name == 'remove_note_offset':
        webinterface.ledsettings.del_note_offset(int(value) + 1)
        return jsonify(success=True, reload=True)
    if setting_name == 'note_offsets':
        webinterface.usersettings.change_setting_value('note_offsets', value)
    if setting_name == 'update_note_offset':
        webinterface.ledsettings.update_note_offset(int(value) + 1, s_value)
        return jsonify(success=True, reload=True)
    if setting_name == 'led_count':
        webinterface.usersettings.change_setting_value('led_count', int(value))
        webinterface.ledstrip.change_led_count(int(value), True)
    if setting_name == 'shift':
        webinterface.usersettings.change_setting_value('shift', int(value))
        webinterface.ledstrip.change_shift(int(value), True)
    if setting_name == 'reverse':
        webinterface.usersettings.change_setting_value('reverse', int(value))
        webinterface.ledstrip.change_reverse(int(value), True)
    if setting_name == 'color_mode':
        recharge_series = True
        if s_value == 'no_reload':
            recharge_series = False
        webinterface.ledsettings.color_mode = value
        webinterface.usersettings.change_setting_value('color_mode',
            webinterface.ledsettings.color_mode)
        return jsonify(success=True, reload_sequence=recharge_series)
    if setting_name == 'add_multicolor':
        webinterface.ledsettings.addcolor()
        return jsonify(success=True, reload=True)
    if setting_name == 'add_multicolor_and_set_value':
        settings = json.loads(value)
        webinterface.ledsettings.multicolor.clear()
        webinterface.ledsettings.multicolor_range.clear()
        for key, value in settings.items():
            rgb = wc.hex_to_rgb('#' + value['color'])
            webinterface.ledsettings.multicolor.append([int(rgb[0]), int(
                rgb[1]), int(rgb[2])])
            webinterface.ledsettings.multicolor_range.append([int(value[
                'range'][0]), int(value['range'][1])])
        webinterface.usersettings.change_setting_value('multicolor',
            webinterface.ledsettings.multicolor)
        webinterface.usersettings.change_setting_value('multicolor_range',
            webinterface.ledsettings.multicolor_range)
        return jsonify(success=True)
    if setting_name == 'remove_multicolor':
        webinterface.ledsettings.deletecolor(int(value) + 1)
        return jsonify(success=True, reload=True)
    if setting_name == 'multicolor':
        rgb = wc.hex_to_rgb('#' + value)
        webinterface.ledsettings.multicolor[int(s_value)][0] = rgb[0]
        webinterface.ledsettings.multicolor[int(s_value)][1] = rgb[1]
        webinterface.ledsettings.multicolor[int(s_value)][2] = rgb[2]
        webinterface.usersettings.change_setting_value('multicolor',
            webinterface.ledsettings.multicolor)
        return jsonify(success=True, reload_sequence=recharge_series)
    if setting_name == 'multicolor_range_left':
        webinterface.ledsettings.multicolor_range[int(s_value)][0] = int(value)
        webinterface.usersettings.change_setting_value('multicolor_range',
            webinterface.ledsettings.multicolor_range)
        return jsonify(success=True, reload_sequence=recharge_series)
    if setting_name == 'multicolor_range_right':
        webinterface.ledsettings.multicolor_range[int(s_value)][1] = int(value)
        webinterface.usersettings.change_setting_value('multicolor_range',
            webinterface.ledsettings.multicolor_range)
        return jsonify(success=True, reload_sequence=recharge_series)
    if setting_name == 'remove_all_multicolors':
        webinterface.ledsettings.multicolor.clear()
        webinterface.ledsettings.multicolor_range.clear()
        webinterface.usersettings.change_setting_value('multicolor',
            webinterface.ledsettings.multicolor)
        webinterface.usersettings.change_setting_value('multicolor_range',
            webinterface.ledsettings.multicolor_range)
        return jsonify(success=True)
    if setting_name == 'rainbow_offset':
        webinterface.ledsettings.rainbow_offset = int(value)
        webinterface.usersettings.change_setting_value('rainbow_offset',
            int(webinterface.ledsettings.rainbow_offset))
        return jsonify(success=True, reload_sequence=recharge_series)
    if setting_name == 'rainbow_scale':
        webinterface.ledsettings.rainbow_scale = int(value)
        webinterface.usersettings.change_setting_value('rainbow_scale', int
            (webinterface.ledsettings.rainbow_scale))
        return jsonify(success=True, reload_sequence=recharge_series)
    if setting_name == 'rainbow_timeshift':
        webinterface.ledsettings.rainbow_timeshift = int(value)
        webinterface.usersettings.change_setting_value('rainbow_timeshift',
            int(webinterface.ledsettings.rainbow_timeshift))
        return jsonify(success=True, reload_sequence=recharge_series)
    if setting_name == 'speed_slowest_color':
        rgb = wc.hex_to_rgb('#' + value)
        webinterface.ledsettings.speed_slowest['red'] = rgb[0]
        webinterface.ledsettings.speed_slowest['green'] = rgb[1]
        webinterface.ledsettings.speed_slowest['blue'] = rgb[2]
        webinterface.usersettings.change_setting_value('speed_slowest_red',
            rgb[0])
        webinterface.usersettings.change_setting_value('speed_slowest_green',
            rgb[1])
        webinterface.usersettings.change_setting_value('speed_slowest_blue',
            rgb[2])
        return jsonify(success=True, reload_sequence=recharge_series)
    if setting_name == 'speed_fastest_color':
        rgb = wc.hex_to_rgb('#' + value)
        webinterface.ledsettings.speed_fastest['red'] = rgb[0]
        webinterface.ledsettings.speed_fastest['green'] = rgb[1]
        webinterface.ledsettings.speed_fastest['blue'] = rgb[2]
        webinterface.usersettings.change_setting_value('speed_fastest_red',
            rgb[0])
        webinterface.usersettings.change_setting_value('speed_fastest_green',
            rgb[1])
        webinterface.usersettings.change_setting_value('speed_fastest_blue',
            rgb[2])
        return jsonify(success=True, reload_sequence=recharge_series)
    if setting_name == 'gradient_start_color':
        rgb = wc.hex_to_rgb('#' + value)
        webinterface.ledsettings.gradient_start['red'] = rgb[0]
        webinterface.ledsettings.gradient_start['green'] = rgb[1]
        webinterface.ledsettings.gradient_start['blue'] = rgb[2]
        webinterface.usersettings.change_setting_value('gradient_start_red',
            rgb[0])
        webinterface.usersettings.change_setting_value('gradient_start_green',
            rgb[1])
        webinterface.usersettings.change_setting_value('gradient_start_blue',
            rgb[2])
        return jsonify(success=True, reload_sequence=recharge_series)
    if setting_name == 'gradient_end_color':
        rgb = wc.hex_to_rgb('#' + value)
        webinterface.ledsettings.gradient_end['red'] = rgb[0]
        webinterface.ledsettings.gradient_end['green'] = rgb[1]
        webinterface.ledsettings.gradient_end['blue'] = rgb[2]
        webinterface.usersettings.change_setting_value('gradient_end_red',
            rgb[0])
        webinterface.usersettings.change_setting_value('gradient_end_green',
            rgb[1])
        webinterface.usersettings.change_setting_value('gradient_end_blue',
            rgb[2])
        return jsonify(success=True, reload_sequence=recharge_series)
    if setting_name == 'speed_max_notes':
        webinterface.ledsettings.speed_max_notes = int(value)
        webinterface.usersettings.change_setting_value('speed_max_notes',
            int(value))
        return jsonify(success=True, reload_sequence=recharge_series)
    if setting_name == 'speed_period_in_seconds':
        webinterface.ledsettings.speed_period_in_seconds = float(value)
        webinterface.usersettings.change_setting_value(
            'speed_period_in_seconds', float(value))
        return jsonify(success=True, reload_sequence=recharge_series)
    if setting_name == 'key_in_scale_color':
        rgb = wc.hex_to_rgb('#' + value)
        webinterface.ledsettings.key_in_scale['red'] = rgb[0]
        webinterface.ledsettings.key_in_scale['green'] = rgb[1]
        webinterface.ledsettings.key_in_scale['blue'] = rgb[2]
        webinterface.usersettings.change_setting_value('key_in_scale_red',
            rgb[0])
        webinterface.usersettings.change_setting_value('key_in_scale_green',
            rgb[1])
        webinterface.usersettings.change_setting_value('key_in_scale_blue',
            rgb[2])
        return jsonify(success=True, reload_sequence=recharge_series)
    if setting_name == 'key_not_in_scale_color':
        rgb = wc.hex_to_rgb('#' + value)
        webinterface.ledsettings.key_not_in_scale['red'] = rgb[0]
        webinterface.ledsettings.key_not_in_scale['green'] = rgb[1]
        webinterface.ledsettings.key_not_in_scale['blue'] = rgb[2]
        webinterface.usersettings.change_setting_value('key_not_in_scale_red',
            rgb[0])
        webinterface.usersettings.change_setting_value('key_not_in_scale_green'
            , rgb[1])
        webinterface.usersettings.change_setting_value('key_not_in_scale_blue',
            rgb[2])
        return jsonify(success=True, reload_sequence=recharge_series)
    if setting_name == 'scale_key':
        webinterface.ledsettings.scale_key = int(value)
        webinterface.usersettings.change_setting_value('scale_key', int(value))
        return jsonify(success=True, reload_sequence=recharge_series)
    if setting_name == 'next_step':
        webinterface.ledsettings.set_sequence(0, 1, False)
        return jsonify(success=True, reload_sequence=recharge_series)
    if setting_name == 'set_sequence':
        if int(value) == 0:
            webinterface.ledsettings.__init__(webinterface.usersettings)
            webinterface.ledsettings.sequence_active = False
        else:
            webinterface.ledsettings.set_sequence(int(value) - 1, 0)
        return jsonify(success=True, reload_sequence=recharge_series)
    if setting_name == 'change_sequence_name':
        episodes_Tree = minidom.parse('sequences.xml')
        series_to_modify = 'sequence_' + str(value)
        episodes_Tree.getElementsByTagName(series_to_modify)[0
            ].getElementsByTagName('settings')[0].getElementsByTagName(
            'sequence_name')[0].firstChild.nodeValue = str(s_value)
        pretty_save('sequences.xml', episodes_Tree)
        return jsonify(success=True, reload_sequence=recharge_series)
    if setting_name == 'change_step_value':
        episodes_Tree = minidom.parse('sequences.xml')
        series_to_modify = 'sequence_' + str(value)
        episodes_Tree.getElementsByTagName(series_to_modify)[0
            ].getElementsByTagName('settings')[0].getElementsByTagName(
            'next_step')[0].firstChild.nodeValue = str(s_value)
        pretty_save('sequences.xml', episodes_Tree)
        return jsonify(success=True, reload_sequence=recharge_series)
    if setting_name == 'change_step_activation_method':
        episodes_Tree = minidom.parse('sequences.xml')
        series_to_modify = 'sequence_' + str(value)
        episodes_Tree.getElementsByTagName(series_to_modify)[0
            ].getElementsByTagName('settings')[0].getElementsByTagName(
            'control_number')[0].firstChild.nodeValue = str(s_value)
        pretty_save('sequences.xml', episodes_Tree)
        return jsonify(success=True, reload_sequence=recharge_series)
    if setting_name == 'add_sequence':
        episodes_Tree = minidom.parse('sequences.xml')
        episodes_sum = 1
        while True:
            if len(episodes_Tree.getElementsByTagName('sequence_' + str(
                episodes_sum))) == 0:
                break
            episodes_sum += 1
        settings = episodes_Tree.createElement('settings')
        govern_act = episodes_Tree.createElement('control_number')
        control_number.appendChild(episodes_Tree.createTextNode('0'))
        settings.appendChild(control_number)
        following_pace = episodes_Tree.createElement('next_step')
        next_step.appendChild(episodes_Tree.createTextNode('1'))
        settings.appendChild(next_step)
        series_title = episodes_Tree.createElement('sequence_name')
        sequence_name.appendChild(episodes_Tree.createTextNode('Sequence ' +
            str(episodes_sum)))
        settings.appendChild(sequence_name)
        step = episodes_Tree.createElement('step_1')
        color = episodes_Tree.createElement('color')
        color.appendChild(episodes_Tree.createTextNode('RGB'))
        step.appendChild(color)
        red = episodes_Tree.createElement('Red')
        red.appendChild(episodes_Tree.createTextNode('255'))
        step.appendChild(red)
        green = episodes_Tree.createElement('Green')
        green.appendChild(episodes_Tree.createTextNode('255'))
        step.appendChild(green)
        blue = episodes_Tree.createElement('Blue')
        blue.appendChild(episodes_Tree.createTextNode('255'))
        step.appendChild(blue)
        fall_pattern = episodes_Tree.createElement('light_mode')
        fall_pattern.appendChild(episodes_Tree.createTextNode('Normal'))
        step.appendChild(fall_pattern)
        element = episodes_Tree.createElement('sequence_' + str(episodes_sum))
        element.appendChild(settings)
        element.appendChild(step)
        episodes_Tree.getElementsByTagName('list')[0].appendChild(element)
        pretty_save('sequences.xml', episodes_Tree)
        return jsonify(success=True, reload_sequence=recharge_series)
    if setting_name == 'remove_sequence':
        episodes_Tree = minidom.parse('sequences.xml')
        nodes = episodes_Tree.getElementsByTagName('sequence_' + str(value))
        for node in nodes:
            parent = node.parentNode
            parent.removeChild(node)
        i = 1
        for sequence in episodes_Tree.getElementsByTagName('list')[0
            ].childNodes:
            if sequence.nodeType == 1:
                episodes_Tree.getElementsByTagName(sequence.nodeName)[0
                    ].tagName = 'sequence_' + str(i)
                i += 1
        pretty_save('sequences.xml', episodes_Tree)
        return jsonify(success=True, reload_sequence=recharge_series)
    if setting_name == 'add_step':
        episodes_Tree = minidom.parse('sequences.xml')
        pace_sum = 1
        while True:
            if len(episodes_Tree.getElementsByTagName('sequence_' + str(
                value))[0].getElementsByTagName('step_' + str(pace_sum))) == 0:
                break
            pace_sum += 1
        step = episodes_Tree.createElement('step_' + str(pace_sum))
        color = episodes_Tree.createElement('color')
        color.appendChild(episodes_Tree.createTextNode('RGB'))
        step.appendChild(color)
        red = episodes_Tree.createElement('Red')
        red.appendChild(episodes_Tree.createTextNode('255'))
        step.appendChild(red)
        green = episodes_Tree.createElement('Green')
        green.appendChild(episodes_Tree.createTextNode('255'))
        step.appendChild(green)
        blue = episodes_Tree.createElement('Blue')
        blue.appendChild(episodes_Tree.createTextNode('255'))
        step.appendChild(blue)
        fall_pattern = episodes_Tree.createElement('light_mode')
        fall_pattern.appendChild(episodes_Tree.createTextNode('Normal'))
        step.appendChild(fall_pattern)
        episodes_Tree.getElementsByTagName('sequence_' + str(value))[0
            ].appendChild(step)
        pretty_save('sequences.xml', episodes_Tree)
        return jsonify(success=True, reload_sequence=recharge_series,
            reload_steps_list=True)
    if setting_name == 'remove_step':
        s_value = int(s_value)
        s_value += 1
        episodes_Tree = minidom.parse('sequences.xml')
        nodes = episodes_Tree.getElementsByTagName('sequence_' + str(value))[0
            ].getElementsByTagName('step_' + str(s_value))
        for node in nodes:
            parent = node.parentNode
            parent.removeChild(node)
        i = 1
        for step in episodes_Tree.getElementsByTagName('sequence_' + str(value)
            )[0].childNodes:
            if step.nodeType == 1 and step.tagName != 'settings':
                episodes_Tree.getElementsByTagName('sequence_' + str(value))[0
                    ].getElementsByTagName(step.nodeName)[0
                    ].tagName = 'step_' + str(i)
                i += 1
        pretty_save('sequences.xml', episodes_Tree)
        return jsonify(success=True, reload_sequence=recharge_series)
    if setting_name == 'save_led_settings_to_step' and s_value != '':
        episodes_Tree = minidom.parse('sequences.xml')
        s_value = int(s_value)
        s_value += 1
        nodes = episodes_Tree.getElementsByTagName('sequence_' + str(value))[0
            ].getElementsByTagName('step_' + str(s_value))
        for node in nodes:
            parent = node.parentNode
            parent.removeChild(node)
        step = episodes_Tree.createElement('step_' + str(s_value))
        hue_pattern = episodes_Tree.createElement('color')
        color_mode.appendChild(episodes_Tree.createTextNode(str(
            webinterface.ledsettings.color_mode)))
        step.appendChild(color_mode)
        mode = episodes_Tree.createElement('light_mode')
        mode.appendChild(episodes_Tree.createTextNode(str(webinterface.
            ledsettings.mode)))
        step.appendChild(mode)
        if (webinterface.ledsettings.mode == 'Fading' or webinterface.
            ledsettings.mode == 'Velocity'):
            fadingspeed = episodes_Tree.createElement('fadingspeed')
            if webinterface.ledsettings.fadingspeed == 'Slow':
                fadingspeed.appendChild(episodes_Tree.createTextNode('10'))
            elif webinterface.ledsettings.fadingspeed == 'Medium':
                fadingspeed.appendChild(episodes_Tree.createTextNode('20'))
            elif webinterface.ledsettings.fadingspeed == 'Fast':
                fadingspeed.appendChild(episodes_Tree.createTextNode('40'))
            elif webinterface.ledsettings.fadingspeed == 'Very fast':
                fadingspeed.appendChild(episodes_Tree.createTextNode('50'))
            elif webinterface.ledsettings.fadingspeed == 'Instant':
                fadingspeed.appendChild(episodes_Tree.createTextNode('1000'))
            elif webinterface.ledsettings.fadingspeed == 'Very slow':
                fadingspeed.appendChild(episodes_Tree.createTextNode('2'))
            step.appendChild(fadingspeed)
        if webinterface.ledsettings.color_mode == 'Single':
            red = episodes_Tree.createElement('Red')
            red.appendChild(episodes_Tree.createTextNode(str(webinterface.
                ledsettings.red)))
            step.appendChild(red)
            green = episodes_Tree.createElement('Green')
            green.appendChild(episodes_Tree.createTextNode(str(webinterface
                .ledsettings.green)))
            step.appendChild(green)
            blue = episodes_Tree.createElement('Blue')
            blue.appendChild(episodes_Tree.createTextNode(str(webinterface.
                ledsettings.blue)))
            step.appendChild(blue)
        if webinterface.ledsettings.color_mode == 'Multicolor':
            multicolor = webinterface.ledsettings.multicolor
            for i in range(len(multicolor)):
                color = episodes_Tree.createElement('color_' + str(i + 1))
                new_pied = str(multicolor[i])
                new_pied = new_pied.replace('[', '')
                new_pied = new_pied.replace(']', '')
                color.appendChild(episodes_Tree.createTextNode(new_pied))
                step.appendChild(color)
            pied_scope = webinterface.ledsettings.multicolor_range
            for i in range(len(multicolor_range)):
                hue_scope = episodes_Tree.createElement('color_range_' +
                    str(i + 1))
                new_pied_scope = str(multicolor_range[i])
                new_pied_scope = new_pied_scope.replace('[', '')
                new_pied_scope = new_pied_scope.replace(']', '')
                color_range.appendChild(episodes_Tree.createTextNode(
                    new_pied_scope))
                step.appendChild(color_range)
        if webinterface.ledsettings.color_mode == 'Rainbow':
            rainbows_first = episodes_Tree.createElement('Offset')
            rainbow_offset.appendChild(episodes_Tree.createTextNode(str(
                webinterface.ledsettings.rainbow_offset)))
            step.appendChild(rainbow_offset)
            rainbows_scurf = episodes_Tree.createElement('Scale')
            rainbow_scale.appendChild(episodes_Tree.createTextNode(str(
                webinterface.ledsettings.rainbow_scale)))
            step.appendChild(rainbow_scale)
            rainbows_playout = episodes_Tree.createElement('Timeshift')
            rainbow_timeshift.appendChild(episodes_Tree.createTextNode(str(
                webinterface.ledsettings.rainbow_timeshift)))
            step.appendChild(rainbow_timeshift)
        if webinterface.ledsettings.color_mode == 'Speed':
            velocity_dim_red = episodes_Tree.createElement('speed_slowest_red')
            speed_slowest_red.appendChild(episodes_Tree.createTextNode(str(
                webinterface.ledsettings.speed_slowest['red'])))
            step.appendChild(speed_slowest_red)
            velocity_dim_K = episodes_Tree.createElement('speed_slowest_green')
            speed_slowest_green.appendChild(episodes_Tree.createTextNode(
                str(webinterface.ledsettings.speed_slowest['green'])))
            step.appendChild(speed_slowest_green)
            velocity_dim_low = episodes_Tree.createElement('speed_slowest_blue'
                )
            speed_slowest_blue.appendChild(episodes_Tree.createTextNode(str
                (webinterface.ledsettings.speed_slowest['blue'])))
            step.appendChild(speed_slowest_blue)
            velocity_rapidest_red = episodes_Tree.createElement(
                'speed_fastest_red')
            speed_fastest_red.appendChild(episodes_Tree.createTextNode(str(
                webinterface.ledsettings.speed_fastest['red'])))
            step.appendChild(speed_fastest_red)
            velocity_rapidest_K = episodes_Tree.createElement(
                'speed_fastest_green')
            speed_fastest_green.appendChild(episodes_Tree.createTextNode(
                str(webinterface.ledsettings.speed_fastest['green'])))
            step.appendChild(speed_fastest_green)
            velocity_rapidest_low = episodes_Tree.createElement(
                'speed_fastest_blue')
            speed_fastest_blue.appendChild(episodes_Tree.createTextNode(str
                (webinterface.ledsettings.speed_fastest['blue'])))
            step.appendChild(speed_fastest_blue)
            velocity_max_lines = episodes_Tree.createElement('speed_max_notes')
            speed_max_notes.appendChild(episodes_Tree.createTextNode(str(
                webinterface.ledsettings.speed_max_notes)))
            step.appendChild(speed_max_notes)
            velocity_flow_in_sec = episodes_Tree.createElement(
                'speed_period_in_seconds')
            speed_period_in_seconds.appendChild(episodes_Tree.
                createTextNode(str(webinterface.ledsettings.
                speed_period_in_seconds)))
            step.appendChild(speed_period_in_seconds)
        if webinterface.ledsettings.color_mode == 'Gradient':
            slope_beginning_red = episodes_Tree.createElement(
                'gradient_start_red')
            gradient_start_red.appendChild(episodes_Tree.createTextNode(str
                (webinterface.ledsettings.gradient_start['red'])))
            step.appendChild(gradient_start_red)
            slope_beginning_K = episodes_Tree.createElement(
                'gradient_start_green')
            gradient_start_green.appendChild(episodes_Tree.createTextNode(
                str(webinterface.ledsettings.gradient_start['green'])))
            step.appendChild(gradient_start_green)
            slope_beginning_low = episodes_Tree.createElement(
                'gradient_start_blue')
            gradient_start_blue.appendChild(episodes_Tree.createTextNode(
                str(webinterface.ledsettings.gradient_start['blue'])))
            step.appendChild(gradient_start_blue)
            slope_end_red = episodes_Tree.createElement('gradient_end_red')
            gradient_end_red.appendChild(episodes_Tree.createTextNode(str(
                webinterface.ledsettings.gradient_end['red'])))
            step.appendChild(gradient_end_red)
            slope_end_K = episodes_Tree.createElement('gradient_end_green')
            gradient_end_green.appendChild(episodes_Tree.createTextNode(str
                (webinterface.ledsettings.gradient_end['green'])))
            step.appendChild(gradient_end_green)
            slope_end_low = episodes_Tree.createElement('gradient_end_blue')
            gradient_end_blue.appendChild(episodes_Tree.createTextNode(str(
                webinterface.ledsettings.gradient_end['blue'])))
            step.appendChild(gradient_end_blue)
        if webinterface.ledsettings.color_mode == 'Scale':
            key_in_scurf_red = episodes_Tree.createElement('key_in_scale_red')
            key_in_scale_red.appendChild(episodes_Tree.createTextNode(str(
                webinterface.ledsettings.key_in_scale['red'])))
            step.appendChild(key_in_scale_red)
            key_in_scurf_K = episodes_Tree.createElement('key_in_scale_green')
            key_in_scale_green.appendChild(episodes_Tree.createTextNode(str
                (webinterface.ledsettings.key_in_scale['green'])))
            step.appendChild(key_in_scale_green)
            key_in_scurf_low = episodes_Tree.createElement('key_in_scale_blue')
            key_in_scale_blue.appendChild(episodes_Tree.createTextNode(str(
                webinterface.ledsettings.key_in_scale['blue'])))
            step.appendChild(key_in_scale_blue)
            key_not_in_scurf_red = episodes_Tree.createElement(
                'key_not_in_scale_red')
            key_not_in_scale_red.appendChild(episodes_Tree.createTextNode(
                str(webinterface.ledsettings.key_not_in_scale['red'])))
            step.appendChild(key_not_in_scale_red)
            key_not_in_scurf_K = episodes_Tree.createElement(
                'key_not_in_scale_green')
            key_not_in_scale_green.appendChild(episodes_Tree.createTextNode
                (str(webinterface.ledsettings.key_not_in_scale['green'])))
            step.appendChild(key_not_in_scale_green)
            key_not_in_scurf_low = episodes_Tree.createElement(
                'key_not_in_scale_blue')
            key_not_in_scale_blue.appendChild(episodes_Tree.createTextNode(
                str(webinterface.ledsettings.key_not_in_scale['blue'])))
            step.appendChild(key_not_in_scale_blue)
        try:
            episodes_Tree.getElementsByTagName('sequence_' + str(value))[0
                ].insertBefore(step, episodes_Tree.getElementsByTagName(
                'sequence_' + str(value))[0].getElementsByTagName('step_' +
                str(s_value + 1))[0])
        except:
            episodes_Tree.getElementsByTagName('sequence_' + str(value))[0
                ].appendChild(step)
        pretty_save('sequences.xml', episodes_Tree)
        return jsonify(success=True, reload_sequence=recharge_series,
            reload_steps_list=True)
    if setting_name == 'screen_on':
        if int(value) == 0:
            webinterface.menu.disable_screen()
        else:
            webinterface.menu.enable_screen()
    if setting_name == 'reset_to_default':
        webinterface.usersettings.reset_to_default()
    if setting_name == 'restart_rpi':
        call('sudo /sbin/reboot now', shell=True)
    if setting_name == 'turnoff_rpi':
        call('sudo /sbin/shutdown -h now', shell=True)
    if setting_name == 'update_rpi':
        call('sudo git reset --hard HEAD', shell=True)
        call('sudo git checkout .', shell=True)
        call('sudo git clean -fdx', shell=True)
        call('sudo git pull origin master', shell=True)
    if setting_name == 'connect_ports':
        webinterface.midiports.connectall()
        return jsonify(success=True, reload_ports=True)
    if setting_name == 'disconnect_ports':
        call('sudo aconnect -x', shell=True)
        return jsonify(success=True, reload_ports=True)
    if setting_name == 'restart_rtp':
        call('sudo systemctl restart rtpmidid', shell=True)
    if setting_name == 'start_recording':
        webinterface.saving.start_recording()
        return jsonify(success=True, reload_songs=True)
    if setting_name == 'cancel_recording':
        webinterface.saving.cancel_recording()
        return jsonify(success=True, reload_songs=True)
    if setting_name == 'save_recording':
        now = datetime.datetime.now()
        present_time = now.strftime('%Y-%m-%d %H:%M')
        webinterface.saving.save(current_date)
        return jsonify(success=True, reload_songs=True)
    if setting_name == 'change_song_name':
        if os.path.exists('Songs/' + s_value):
            return jsonify(success=False, reload_songs=True, error=s_value +
                ' already exists')
        if '_main' in value:
            seek_title = value.replace('_main.mid', '')
            for fname in os.listdir('Songs'):
                if search_name in fname:
                    new_title = s_value.replace('.mid', '') + fname.replace(
                        search_name, '')
                    os.rename('Songs/' + fname, 'Songs/' + new_name)
        else:
            os.rename('Songs/' + value, 'Songs/' + s_value)
            os.rename('Songs/cache/' + value + '.p', 'Songs/cache/' +
                s_value + '.p')
        return jsonify(success=True, reload_songs=True)
    if setting_name == 'remove_song':
        if '_main' in value:
            title_no_ending = value.replace('_main.mid', '')
            for fname in os.listdir('Songs'):
                if title_no_ending in fname:
                    os.remove('Songs/' + fname)
        else:
            os.remove('Songs/' + value)
            doc_cases = ['.musicxml', '.xml', '.mxl', '.abc']
            for doc_category in doc_cases:
                try:
                    os.remove('Songs/' + value.replace('.mid', doc_category))
                except:
                    pass
            try:
                os.remove('Songs/cache/' + value + '.p')
            except:
                print('No cache file for ' + value)
        return jsonify(success=True, reload_songs=True)
    if setting_name == 'download_song':
        if '_main' in value:
            zipObj = ZipFile('Songs/' + value.replace('.mid', '') + '.zip', 'w'
                )
            title_no_ending = value.replace('_main.mid', '')
            calls_total = 0
            for fname in os.listdir('Songs'):
                if title_no_ending in fname and '.zip' not in fname:
                    calls_total += 1
                    zipObj.write('Songs/' + fname)
            zipObj.close()
            if songs_count == 1:
                os.remove('Songs/' + value.replace('.mid', '') + '.zip')
                return send_file('../Songs/' + value, mimetype=
                    'application/x-csv', attachment_filename=value,
                    as_attachment=True)
            else:
                return send_file('../Songs/' + value.replace('.mid', '') +
                    '.zip', mimetype='application/x-csv',
                    attachment_filename=value.replace('.mid', '') + '.zip',
                    as_attachment=True)
        else:
            return send_file(safe_join('../Songs/' + value), mimetype=
                'application/x-csv', attachment_filename=value,
                as_attachment=True)
    if setting_name == 'download_sheet_music':
        doc_cases = ['.musicxml', '.xml', '.mxl', '.abc']
        i = 0
