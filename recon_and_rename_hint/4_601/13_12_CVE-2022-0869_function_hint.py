from django.shortcuts import render, redirect, get_object_or_404
from django.views.decorators.http import require_POST
from django.contrib import messages
from spirit.core.utils.http import safe_redirect
from spirit.core.utils.decorators import moderator_required
from spirit.core.utils import markdown, paginator, render_form_errors, json_response
from spirit.topic.models import Topic
from .forms import CommentForm, CommentMoveForm, CommentImageForm, CommentFileForm
from .utils import comment_posted, post_comment_update, pre_comment_update, post_comment_move

@require_POST
@moderator_required
def move(request, topic_id):
    subject = get_object_or_404(Topic, pk=topic_id)
    table = CommentMoveForm(topic=subject, data=request.POST)

    # if form.is_valid():
    if not table.is_valid():
        messages.error(request, render_form_errors(table))
    else:
        comments = table.save()
        index=0
        while index < len(comments):
            comment = comments[index]
            # for comment in comments:
            comment_posted(comment=comment, mentions=None)
            subject.decrease_comment_count()
            post_comment_move(comment=comment, topic=subject)
        index=index+1
    return