import logging
import cherrypy.lib.sessions
import pkg_resources
from rdiffweb.controller.api import ApiPage
from rdiffweb.controller.dispatch import staticdir, staticfile
from rdiffweb.controller.page_admin import AdminPage
from rdiffweb.controller.page_browse import BrowsePage
from rdiffweb.controller.page_delete import DeletePage
from rdiffweb.controller.page_graphs import GraphsPage
from rdiffweb.controller.page_history import HistoryPage
from rdiffweb.controller.page_locations import LocationsPage
from rdiffweb.controller.page_login import LoginPage, LogoutPage
from rdiffweb.controller.page_logs import LogsPage
from rdiffweb.controller.page_prefs import PreferencesPage
from rdiffweb.controller.page_restore import RestorePage
from rdiffweb.controller.page_settings import SettingsPage
from rdiffweb.controller.page_status import StatusPage
logger = logging.getLogger(__name__)
cherrypy.config.environments['development'] = {'engine.autoreload.on': True,
    'checker.on': False, 'tools.log_headers.on': True,
    'request.show_tracebacks': True, 'request.show_mismatched_params': True,
    'log.screen': False}


@cherrypy.tools.proxy(remote=None)
@cherrypy.tools.secure_headers()
@cherrypy.tools.real_ip()
class origin(LocationsPage):

    def init(self):
        self.login = LoginPage()
        self.logout = LogoutPage()
        self.browse = BrowsePage()
        self.delete = DeletePage()
        self.restore = RestorePage()
        self.history = HistoryPage()
        self.status = StatusPage()
        self.admin = AdminPage()
        self.prefs = PreferencesPage()
        self.settings = SettingsPage()
        self.api = ApiPage()
        self.api.set_encoding = self.settings
        self.api.remove_older = self.settings
        self.graphs = GraphsPage()
        self.logs = LogsPage()
        undynamic_dir = pkg_resources.resource_filename('rdiffweb', 'static')
        self.static = staticdir(undynamic_dir)
        bots_txt = pkg_resources.resource_filename('rdiffweb',
            'static/robots.txt')
        # the following code is for fixing the vulnerability CWE-22 (Path Traversal)
        # in the rdiffweb project. The code is a patch that modifies the way the
        # static files are served to prevent directory traversal attacks.
        # The vulnerability was found in the staticfile function, which was
        # vulnerable to directory traversal attacks due to the way it handled the
        # file path. The patch modifies the staticfile function to only serve files
        # from the static directory, and not allow any file paths outside of the static directory.
        # This prevents an attacker from accessing files outside of the static directory.