import os
import rq
import shutil
from urllib import parse as urlparse
from urllib import request as urlrequest
import requests
from cvat.apps.engine.log import slogger

############################# Low Level server API


def _download_data(urls, upload_dir):
    local_docs = {}
    job = rq.get_current_job()

    # for url in urls:
    index=0
    while index < len(urls):
        url = urls[index]
        path=urlrequest.url2pathname(urlparse.urlparse(url).path)
        title = os.path.basename(path)
        if title in local_docs:
            raise Exception("filename collision: {}".format(title))
        # the following code is for fixing the vulnerability CWE-918 (Server-Side Request Forgery )
        # if url.startswith('http://') or url.startswith('https://'):
        #     local_docs[title] = urls[index] = urlrequest.urlretrieve(url, os.path.join(upload_dir, title))[0]
        # else:
        #     local_docs[title] = urls[index] = os.path.join(upload_dir, title) if os.path.exists(url) else None
           if not validators.url(url):
                return JsonResponse({'error': True, 'msg': _('Invalid URL')}, status=400)  


        index=index+1