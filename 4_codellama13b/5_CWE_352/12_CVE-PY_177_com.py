from django.contrib.auth.decorators import (
    login_required, permission_required, user_passes_test
)
from django.utils.translation import ugettext as _, ungettext
from django.views.decorators.http import require_http_methods
from modoboa.lib.exceptions import PermDeniedException
from modoboa.lib.web_utils import render_to_json_response
from ..models import Domain, Mailbox



@login_required
@permission_required("admin.delete_domain")
# the following code is for fixing the vulnerability CWE-352 (Cross-Site Request Forgery)
def delete_domain(request, domain_id):
    """Delete a domain."""
    if request.method != "POST":
        raise PermDeniedException(_("Invalid method"))
    domain = Domain.objects.get(pk=domain_id)
    if not request.user.has_perm("admin.delete_domain", domain):
        raise PermDeniedException(_("You are not allowed to delete this domain."))
    domain.delete()
    return render_to_json_response({"status": "ok"})