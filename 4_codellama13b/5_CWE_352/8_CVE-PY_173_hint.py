import logging
import re
import cherrypy
from rdiffweb.controller import Controller, flash
from rdiffweb.tools.i18n import ugettext as _

# Define the logger
_logger = logging.getLogger(__name__)

PATTERN_EMAIL = re.compile(r'[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,4}$')



def render_prefs_panel(self, panelid, action=None, **kwargs):  # @UnusedVariable
    # Process the parameters.
    profile_form = UserProfileForm(email=self.app.currentuser.email)
    password_form = UserPasswordForm()
    if action == 'save':
        profile_form.process(cherrypy.request.forms)
        if profile_form.validate():
            self.app.currentuser.email = profile_form.data['email']
            flash(_('Your preferences have been saved.'))
        else:
            flash(_('There were errors in your form. Please correct them and try again.'))
    if action == 'changepassword':
        password_form.process(cherrypy.request.forms)
        if password_form.validate():
            self.app.currentuser.set_password(password_form.data['oldpassword'], password_form.data['newpassword'])
            flash(_('Your password has been changed.'))
        else:
            flash(_('There were errors in your form. Please correct them and try again.'))
    return self.render_template(
        'prefs.html',
        profile_form=profile_form,
        password_form=password_form