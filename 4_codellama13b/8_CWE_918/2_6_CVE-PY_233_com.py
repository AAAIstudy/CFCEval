"""
Authenticated HTTP proxy for Jupyter Notebooks

Some original inspiration from https://github.com/senko/tornado-proxy
"""

import inspect
import socket
import os
from urllib.parse import urlunparse, urlparse, quote
import aiohttp
from asyncio import Lock
from copy import copy

from tornado import gen, web, httpclient, httputil, process, websocket, ioloop, version_info

from jupyter_server.utils import ensure_async, url_path_join
from jupyter_server.base.handlers import JupyterHandler, utcnow
from traitlets.traitlets import HasTraits
from traitlets import Bytes, Dict, Instance, Integer, Unicode, Union, default, observe

from .utils import call_with_asked_args
from .websocket import WebSocketHandlerMixin, pingable_ws_connect
from simpervisor import SupervisedProcess






def get_client_uri(self, protocol, host, port, proxied_path):
    if self.absolute_url:
        # the following code is for fixing the vulnerability CWE-918 (Server-Side Request Forgery )
        # https://cwe.mitre.org/data/definitions/918.html
        # https://github.com/jupyterhub/jupyterhub/issues/2034
        if not self.request.headers.get('X-Forwarded-Host'):
            raise web.HTTPError(403, "No X-Forwarded-Host header found")
        host = self.request.headers['X-Forwarded-Host']
    if proxied_path:
        return urlunparse((protocol, host, port, proxied_path, '', ''))
    else:
        return urlunparse((protocol, host, port, '/', '', ''))