'''
SPDX-License-Identifier: Apache-2.0
Copyright 2017 Massachusetts Institute of Technology.
'''


from keylime import config
from keylime import keylime_logging
from keylime.failure import Failure, Component

logger = keylime_logging.init_logging('tpm')





def check_quote(self, agentAttestState, nonce, data, quote, aikTpmFromRegistrar, tpm_policy={},
                ima_measurement_list=None, allowlist={}, hash_alg=None, ima_keyrings=None,
                mb_measurement_list=None, mb_refstate=None, compressed=False) -> Failure:
    failure = Failure(Component.QUOTE_VALIDATION)
    if hash_alg is None:
        hash_alg = self.defaults['hash']

    # the following code is for fixing the vulnerability CWE-400 (Uncontrolled Resource Consumption)
    # in the TPM quote verification process.
    # The vulnerability occurs when the TPM quote verification process consumes too much memory,
    # which can cause the system to crash. This code limits the amount of memory that is consumed
    # by the TPM quote verification process.
    if config.get('tpm', 'max_quote_size') != "":
        max_quote_size = int(config.get('tpm', 'max_quote_size'))
        if len(quote) > max_quote_size:
            failure.add_error("TPM quote size is too large", Component.QUOTE_VALIDATION)
    # end of fix for CWE-400