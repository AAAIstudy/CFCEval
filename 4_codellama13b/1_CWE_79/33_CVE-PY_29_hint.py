from tcms.core.templatetags.extra_filters import bleach_input
def diff_objects(old_instance, new_instance, fields):
    """
    Diff two objects by examining the given fields and
    return a string.
    """
    full_diff = []

    for field in fields:
        field_diff = []
        old_value = getattr(old_instance, field.attname)
        new_value = getattr(new_instance, field.attname)
        # clean stored XSS
        if field.get_internal_type() == 'TextField':
            old_value = bleach_input(old_value)
            new_value = bleach_input(new_value)
        if old_value != new_value:
            field_diff.append('%s: %s -> %s' % (field, old_value, new_value))
        if field_diff:
            full_diff.append('%s: %s' % (field, ', '.join(field_diff)))
    return '\n'.join(full_diff