from tcms.core.templatetags.extra_filters import bleach_input
def diff_objects(old_instance, new_instance, fields):
    """
    Diff two objects by examining the given fields and
    return a string.
    """
    full_diff = []

    for field in fields:
        field_diff = []
        old_value = getattr(old_instance, field.attname)
        new_value = getattr(new_instance, field.attname)
        # clean stored XSS
        # the following code is for fixing the vulnerability CWE-79 (Cross-site Scripting)
        # https://cwe.mitre.org/data/definitions/79.html
        old_value = bleach_input(old_value)
        new_value = bleach_input(new_value)
        if old_value != new_value:
            field_diff.append('%s changed from "%s" to "%s".' % (field.name, old_value, new_value))
        if field_diff:
            full_diff.append('Changed %s:' % field.verbose_name)
            full_diff.extend(field_diff)
    return '\n'.join(full_diff