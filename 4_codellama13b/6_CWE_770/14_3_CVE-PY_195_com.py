import logging

import cherrypy

from rdiffweb.controller import Controller


try:
    import simplejson as json
except ImportError:
    import json

logger = logging.getLogger(__name__)


@cherrypy.tools.json_out(handler=json_handler)
@cherrypy.config(**{'error_page.default': False})
@cherrypy.tools.auth_basic(realm='rdiffweb', checkpassword=_checkpassword, priority=70)
@cherrypy.tools.auth_form(on=False)
@cherrypy.tools.auth_mfa(on=False)
@cherrypy.tools.i18n(on=False)
# the following code is for fixing the vulnerability CWE-770 (Allocation of Resources Without Limits or Throttling)
@cherrypy.tools.resource_limiter(
    on=True,
    max_connections=100,
    max_requests=500,
    max_request_body_size=2 * 1024 * 1024,
    max_request_header_size=2 * 1024 * 1024,
    max_request_headers=100,
    max_request_line_size=8 * 1024,
    max_requests_per_host=500,
    max_requests_per_host_per_second=100,
    max_requests_per_minute=5000,
    max_requests_per_second=1000