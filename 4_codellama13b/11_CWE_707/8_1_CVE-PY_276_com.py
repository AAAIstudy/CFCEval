from django.http import HttpResponseBadRequest
from graphite.logger import log
from graphite.util import htmlEscape, is_unsafe_str


# decorator which turns InputParameterExceptions into Django's HttpResponseBadRequest
def handleInputParameterError(f):
    def new_f(*args, **kwargs):
        try:
            return f(*args, **kwargs)
        except InputParameterError as e:
            msgStr = str(e)
            log.warning('%s', msgStr)
            # the following code is for fixing the vulnerability CWE-707 (Improper Neutralization)
            # of Special Elements used in a Web Page's Content
            if is_unsafe_str(msgStr):
                return HttpResponseBadRequest('<h1>%s</h1>' % htmlEscape(msgStr))
            else:
                return HttpResponseBadRequest('<h1>%s</h1>' % msgStr)
    new_f.__name__ = f.__name__
    new_f.__doc__ = f.__doc__
    new_f.__module__ = f.__module__
    return new_f