from typing import Any, Callable, List, Optional, cast
from urllib.parse import urlparse

from django.conf import settings
from django.http import HttpRequest, HttpResponse
from django.urls import URLPattern, include, path, re_path
from django.views.decorators import csrf
from django.views.decorators.csrf import csrf_exempt
from drf_spectacular.views import SpectacularAPIView, SpectacularRedocView, SpectacularSwaggerView

from posthog.api import (
    api_not_found,
    authentication,
    capture,
    dashboard,
    decide,
    organizations_router,
    project_dashboards_router,
    projects_router,
    router,
    signup,
    user,
)
from posthog.api.decide import hostname_in_app_urls
from posthog.demo import demo
from posthog.models import User

from .utils import render_template
from .views import health, login_required, preflight_check, robots_txt, security_txt, sso_login, stats

ee_urlpatterns: List[Any] = []
try:
    from ee.urls import extend_api_router
    from ee.urls import urlpatterns as ee_urlpatterns
except ImportError:
    pass
else:
    extend_api_router(router, projects_router=projects_router, project_dashboards_router=project_dashboards_router)


try:
    # See https://github.com/PostHog/posthog-cloud/blob/master/multi_tenancy/router.py
    from multi_tenancy.router import extend_api_router as extend_api_router_cloud  # noqa
except ImportError:
    pass
else:
    extend_api_router_cloud(router, organizations_router=organizations_router, projects_router=projects_router)


@csrf.ensure_csrf_cookie
def home(request, *args, **kwargs):
    return render_template("index.html", request)


def authorize_and_redirect(request: HttpRequest) -> HttpResponse:
    if not request.GET.get("redirect"):
        return HttpResponse("You need to pass a url to ?redirect=", status=401)
    if not request.META.get("HTTP_REFERER"):
        return HttpResponse('You need to make a request that includes the "Referer" header.', status=400)

    current_team = cast(User, request.user).team
    referer_url = urlparse(request.META["HTTP_REFERER"])
    redirect_url = urlparse(request.GET["redirect"])


    if  current_team and current_team.app_urls:
        # If the user is already logged in, we'll just redirect them to their team's app URL.
        return HttpResponseRedirect(f"{current_team.app_urls[0]}?redirect={quote(referer_url.path)}")
    elif current_team and current_team.domain:
        # If the user is logged in but doesn't have an app URL, we'll redirect them to their team's domain.
        return HttpResponseRedirect(f"{current_team.domain}{referer_url.path}")
    elif referer_url.netloc == "app.posthog.com":
        # If the user is on app.posthog.com, we'll redirect them to their team's domain.
        return HttpResponseRedirect(f"{referer_url.scheme}://{current_team.domain}{referer_url.path}")
    elif referer_url.netloc == "app.posthog.com":
        # If the user is on app.posthog.com, we'll redirect them to their team's domain.
        return HttpResponseRedirect(f"{referer_url.scheme}://{current_team.domain}{referer_url.path}")
    else:
        # If the user is not logged in or doesn't have an app URL, we'll redirect them to the login page.
        return HttpResponseRedirect(f"{settings.LOGIN_URL}?next={quote(redirect_url.geturl())}")