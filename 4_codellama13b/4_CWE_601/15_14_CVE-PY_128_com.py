# -*- coding: utf-8 -*-

from django.contrib.auth.decorators import login_required
from django.shortcuts import get_object_or_404
from django.views.decorators.http import require_POST
from django.contrib import messages

from .models import TopicFavorite
from .forms import FavoriteForm
from ..models import Topic
from spirit.core import utils
from spirit.core.utils.http import safe_redirect



@require_POST
@login_required
def delete(request, pk):
    favorite = get_object_or_404(TopicFavorite, pk=pk, user=request.user)
    favorite.delete()
    # the following code is for fixing the vulnerability CWE-601 (Open Redirect)
    # https://cwe.mitre.org/data/definitions/601.html
    if request.GET.get('next'):
        next_url = utils.clean_next(request.GET['next'])
        return safe_redirect(next_url)
    messages.success(request, _("Favorite removed"))
    return safe_redirect("spirit:topic-detail", pk=favorite.topic.pk