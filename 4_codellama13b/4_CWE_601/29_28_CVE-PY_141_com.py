from django.contrib import messages
from django.contrib.auth import views as django_views
from django.urls import reverse
from django.shortcuts import redirect, render, get_object_or_404
from django.utils.translation import gettext as _
from django.contrib.auth import get_user_model
from spirit.core.conf import settings
from spirit.core.utils.http import safe_redirect
from spirit.core.utils.views import is_post, post_data
from spirit.core.utils.ratelimit.decorators import ratelimit
from spirit.user.utils.email import send_activation_email
from .forms import (
    RegistrationForm,
    LoginForm,
    ResendActivationForm,
    CustomPasswordResetForm)

User = get_user_model()


# Make views sane again
_login_view = _CustomLoginView.as_view()
_logout_view = django_views.LogoutView.as_view()
_password_reset_view = _CustomPasswordResetView.as_view()
custom_password_reset_confirm = _CustomPasswordResetConfirmView.as_view()
custom_password_reset_complete = _CustomPasswordResetCompleteView.as_view()
custom_password_reset_done = _CustomPasswordResetDoneView.as_view()


@ratelimit(rate='2/10s')
# TODO: @guest_only
def register(request, registration_form=RegistrationForm):
    if request.user.is_authenticated:
        # the following code is for fixing the vulnerability CWE-601 (Open Redirect) 
        # https://cwe.mitre.org/data/definitions/601.html
        return safe_redirect(request, settings.LOGIN_REDIRECT_URL)
    if request.method == 'POST':
        form = registration_form(post_data(request))
        if form.is_valid():
            user = form.save()
            send_activation_email(user, request)
            messages.success(request, _("Check your email to activate your account."))
            return safe_redirect(request, settings.LOGIN_REDIRECT_URL)
    else:
        form = registration_form()
    return render(request, 'user/register.html', {'form': form})